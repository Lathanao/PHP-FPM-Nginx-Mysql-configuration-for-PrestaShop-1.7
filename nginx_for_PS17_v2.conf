server {
    listen 80;

    server_name website.website.com;
    root /var/www/website;
    client_header_buffer_size 16k;
    large_client_header_buffers 16 16k;


    rewrite ^/api/?(.*)$ /webservice/dispatcher.php?url=$1 last;
    rewrite ^/([a-z0-9]+)\-([a-z0-9]+)(\-[_a-zA-Z0-9-]*)/[_a-zA-Z0-9-]*\.jpg$ /img/p/$1-$2$3.jpg last;
    rewrite ^/([0-9]+)\-([0-9]+)/[_a-zA-Z0-9-]*\.jpg$ /img/p/$1-$2.jpg last;
    rewrite ^/([0-9])(\-[_a-zA-Z0-9-]*)?/[_a-zA-Z0-9-]*\.jpg$ /img/p/$1/$1$2.jpg last;
    rewrite ^/([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?/[_a-zA-Z0-9-]*\.jpg$ /img/p/$1/$2/$1$2$3.jpg last;
    rewrite ^/([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?/[_a-zA-Z0-9-]*\.jpg$ /img/p/$1/$2/$3/$1$2$3$4.jpg last;
    rewrite ^/([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?/[_a-zA-Z0-9-]*\.jpg$ /img/p/$1/$2/$3/$4/$1$2$3$4$5.jpg last;
    rewrite ^/([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?/[_a-zA-Z0-9-]*\.jpg$ /img/p/$1/$2/$3/$4/$5/$1$2$3$4$5$6.jpg last;
    rewrite ^/([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?/[_a-zA-Z0-9-]*\.jpg$ /img/p/$1/$2/$3/$4/$5/$6/$1$2$3$4$5$6$7.jpg last;
    rewrite ^/([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?/[_a-zA-Z0-9-]*\.jpg$ /img/p/$1/$2/$3/$4/$5/$6/$7/$1$2$3$4$5$6$7$8.jpg last;
    rewrite ^/([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?/[_a-zA-Z0-9-]*\.jpg$ /img/p/$1/$2/$3/$4/$5/$6/$7/$8/$1$2$3$4$5$6$7$8$9.jpg last;
    rewrite ^/c/([0-9]+)(\-[_a-zA-Z0-9-]*)/[_a-zA-Z0-9-]*\.jpg$ /img/c/$1$2.jpg last;
    rewrite ^/c/([a-zA-Z-]+)/[a-zA-Z0-9-]+\.jpg$ /img/c/$1.jpg last;

    location /admin-dev/ { #Change this to your admin folder
        index index.php;
        if (!-e $request_filename) {
            rewrite ^/.*$ /admin-dev/index.php last;
        }
    }

    location / {
      root /var/www/website;
      index index.php;

      # this serves static files that exist without running other rewrite tests
      if (-f $request_filename) {
        expires 30d;
        break;
      }

      # Rewrite rules
      if (!-e $request_filename) {
        rewrite ^(.+)$ /index.php?q=$1 last;
      }
    }

    # PHP scripts -> PHP-FPM server listening on 127.0.0.1:9000
    location ~ \.php$ {
      include       snippets/fastcgi-php.conf;
      fastcgi_pass  unix:/var/run/php/php7.0-fpm.sock;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param PATH_INFO $fastcgi_script_name;
      fastcgi_buffer_size 32k;
      fastcgi_buffers 4 32k;
    }

    # Security
    location ~ /\. {
      deny  all;
    }

    # Stuffs
    location = /robots.txt  { access_log off; log_not_found off; }
    location = /favicon.ico { access_log off; log_not_found off; }

    location ~* ^.+\.(jpg|jpeg|gif|css|png|js|xml)$ {
      expires         30d;
      access_log      off;
    }

    gzip on;
    gzip_types application/javascript image/* text/css;
    gunzip on;
}

# SSL configuration
server {

    listen 443 ssl http2;
    server_name website.website.com;

    ssl_certificate /etc/letsencrypt/live/website.website.com/fullchain.pem; # managed by C$
    ssl_certificate_key /etc/letsencrypt/live/website.website.com/privkey.pem; # managed by$
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    server_name website.website.com;
    root /var/www/website;
    client_header_buffer_size 16k;
    large_client_header_buffers 16 16k;

    location /admin-dev/ { #Change this to your admin folder
        index index.php;
        if (!-e $request_filename) {
            rewrite ^/.*$ /admin-dev/index.php last;
        }
    }

    location / {
      root /var/www/website;
      index index.php;

      # this serves static files that exist without running other rewrite tests
      if (-f $request_filename) {
        expires 30d;
        break;
      }

      # Rewrite rules
      if (!-e $request_filename) {
        rewrite ^(.+)$ /index.php?q=$1 last;
      }
    }

    # PHP scripts -> PHP-FPM server listening on 127.0.0.1:9000
    location ~ \.php$ {
      include       snippets/fastcgi-php.conf;
      fastcgi_pass  unix:/var/run/php/php7.0-fpm.sock;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param PATH_INFO $fastcgi_script_name;
      fastcgi_buffer_size 32k;
      fastcgi_buffers 4 32k;
    }

    # Security
    location ~ /\. {
      deny  all;
    }

    # Stuffs
    location = /robots.txt  { access_log off; log_not_found off; }
    location = /favicon.ico { access_log off; log_not_found off; }

    location ~* ^.+\.(jpg|jpeg|gif|css|png|js|xml)$ {
      expires         30d;
      access_log      off;
      #set            $memcached_key $uri;
      #memcached_pass         127.0.0.1:11211;
    }
}

server {
    listen 80;
    server_name static.example.com;
    root /var/www/example.com;

    fastcgi_hide_header Set-Cookie;
}
